filter(b_vxrate,
adm_date_eom == "Yes" &
adm_date_month == 12 & adm_date_year == 2021)
#### Calculate cov_total_fv at end of December 2021
c_vxrate_dec <- c_vxrate_dec %>%
mutate(cov_total_fv = if_else(
adm_a1d == 0 & adm_fv == 0 & adm_booster == 0, ((adm_td / 2) / a_pop),
if_else(adm_a1d == 0 & adm_fv == 0 & adm_booster != 0, (((adm_td - adm_booster)/ 2) / a_pop),
if_else(adm_a1d != 0 & adm_fv == 0 & adm_booster == 0, ((adm_td - adm_a1d) / a_pop),
if_else(adm_a1d != 0 & adm_fv == 0 & adm_booster != 0, ((adm_td - adm_a1d - adm_booster) / a_pop),
(adm_fv / a_pop))))))
#### Indicate if cov_total_fv is greater than or equal to 20%
c_vxrate_dec <- c_vxrate_dec %>%
mutate(t20_goalmet_dec = if_else(cov_total_fv > .2, "Yes", "No"))
#### Indicate if cov_total_fv is greater than or equal to 40%
c_vxrate_dec <- c_vxrate_dec %>%
mutate(t40_goalmet_dec = if_else(cov_total_fv > .4, "Yes", "No"))
#### Reduce to a_iso, t20_goalmet_dec, t40_goalmet_dec
c_vxrate_dec_t2040 <-
select(c_vxrate_dec,
c("a_iso", "t20_goalmet_dec", "t40_goalmet_dec"))
## Create absorption by month table
c_vxrate_eom <- filter(b_vxrate, adm_date_eom == "Yes")
### Select relevant columns
c_vxrate_eom <-
select(
c_vxrate_eom,
c(
"a_iso",
"a_who_region",
"a_continent",
"a_covax_status",
"a_income_group",
"adm_date_month",
"adm_td"
)
)
### Create temporary previous month data frame to allow calculation
z_vxrate_eom_temp <-
select(c_vxrate_eom, c("a_iso", "adm_date_month", "adm_td"))
z_vxrate_eom_temp <- z_vxrate_eom_temp %>%
mutate(adm_date_month = adm_date_month + 1)
colnames(z_vxrate_eom_temp) <-
c("a_iso", "adm_date_month", "adm_td_lm")
### Calculate change by month
c_vxrate_eom <-
left_join(
c_vxrate_eom,
z_vxrate_eom_temp,
by = c("a_iso" = "a_iso", "adm_date_month" = "adm_date_month")
)
c_vxrate_eom <- c_vxrate_eom %>%
mutate(adm_td_absorbed = adm_td - adm_td_lm)
c_vxrate_eom <- c_vxrate_eom %>%
mutate(adm_td_absorbed = if_else(is.na(adm_td_absorbed), adm_td, adm_td_absorbed))
## Summarize absorption by grouping by month
### COVAX participation = AMC
c_vxrate_eom_amc <- filter(c_vxrate_eom, a_covax_status == "AMC")
d_absorption_amc <- c_vxrate_eom_amc %>%
group_by(adm_date_month) %>%
summarize(absorption_amc = sum(adm_td_absorbed))
#### COVAX participation = AMC91
c_vxrate_eom_amc91 <-
filter(c_vxrate_eom, a_covax_status == "AMC" & a_iso != "IND")
d_absorption_amc91 <- c_vxrate_eom_amc91 %>%
group_by(adm_date_month) %>%
summarize(absorption_amc91 = sum(adm_td_absorbed))
#### Continent = Africa
c_vxrate_eom_africa <- filter(c_vxrate_eom, a_continent == "Africa")
d_absorption_africa <- c_vxrate_eom_africa %>%
group_by(adm_date_month) %>%
summarize(absorption_africa = sum(adm_td_absorbed))
#### WHO region = EMR
c_vxrate_eom_emr <- filter(c_vxrate_eom, a_who_region == "EMR")
d_absorption_emr <- c_vxrate_eom_emr %>%
group_by(adm_date_month) %>%
summarize(absorption_emr = sum(adm_td_absorbed))
#### WHO region = AFR
c_vxrate_eom_afr <- filter(c_vxrate_eom, a_who_region == "AFR")
d_absorption_afr <- c_vxrate_eom_afr %>%
group_by(adm_date_month) %>%
summarize(absorption_afr = sum(adm_td_absorbed))
#### WHO region = SEAR
c_vxrate_eom_sear <- filter(c_vxrate_eom, a_who_region == "SEAR")
d_absorption_sear <- c_vxrate_eom_sear %>%
group_by(adm_date_month) %>%
summarize(absorption_sear = sum(adm_td_absorbed))
#### WHO region = WPR
c_vxrate_eom_wpr <- filter(c_vxrate_eom, a_who_region == "WPR")
d_absorption_wpr <- c_vxrate_eom_wpr %>%
group_by(adm_date_month) %>%
summarize(absorption_wpr = sum(adm_td_absorbed))
#### WHO region = EUR
c_vxrate_eom_eur <- filter(c_vxrate_eom, a_who_region == "EUR")
d_absorption_eur <- c_vxrate_eom_eur %>%
group_by(adm_date_month) %>%
summarize(absorption_eur = sum(adm_td_absorbed))
#### WHO region = AMR
c_vxrate_eom_amr <- filter(c_vxrate_eom, a_who_region == "AMR")
d_absorption_amr <- c_vxrate_eom_amr %>%
group_by(adm_date_month) %>%
summarize(absorption_amr = sum(adm_td_absorbed))
#### Additional groupings as needed
#### ...
### Merge groupings monthly absorption data
d_absorption <-
left_join(d_absorption_amc, d_absorption_africa, by = "adm_date_month") %>%
left_join(., d_absorption_emr, by = "adm_date_month") %>%
left_join(., d_absorption_amr, by = "adm_date_month") %>%
left_join(., d_absorption_afr, by = "adm_date_month") %>%
left_join(., d_absorption_sear, by = "adm_date_month") %>%
left_join(., d_absorption_wpr, by = "adm_date_month") %>%
left_join(., d_absorption_eur, by = "adm_date_month") %>%
left_join(., d_absorption_amc91, by = "adm_date_month")
d_absorption <- d_absorption %>%
mutate(adm_date_month_name = if_else(
adm_date_month == 1,
"2021-01",
if_else(
adm_date_month == 2,
"2021-02",
if_else(
adm_date_month == 3,
"2021-03",
if_else(
adm_date_month == 4,
"2021-04",
if_else(
adm_date_month == 5,
"2021-05",
if_else(
adm_date_month == 6,
"2021-06",
if_else(
adm_date_month == 7,
"2021-07",
if_else(
adm_date_month == 8,
"2021-08",
if_else(
adm_date_month == 9,
"2021-09",
if_else(
adm_date_month == 10,
"2021-10",
if_else(
adm_date_month == 11,
"2021-11",
if_else(
adm_date_month == 12,
"2021-12",
if_else(adm_date_month == 13, "2022-01",
NA_character_)
)
)
)
)
)
)
)
)
)
)
)
))
## Create latest value summary table
c_vxrate_latest <- filter(b_vxrate, adm_latest == "Yes")
### Remove is_latest column
c_vxrate_latest <- select(c_vxrate_latest, -c("adm_latest"))
# Last week dataset
## Select relevant columns and rename
b_vxrate_lw_sum <-
select(
b_vxrate_lw_sum,
c(
"iso_code",
"rolling_4_week_avg_td",
"rolling_4_week_avg_td_lastmonth",
"fully_vaccinated"
)
)
colnames(b_vxrate_lw_sum) <-
c("a_iso", "dvr_4wk_td_lw", "dvr_4wk_td_lw_lm", "adm_fv_lw")
## Calculate percent change and category
b_vxrate_change_lw <- b_vxrate_lw_sum %>%
mutate(dvr_4wk_td_change_lw_lm = dvr_4wk_td_lw - dvr_4wk_td_lw_lm) %>%
mutate(dvr_4wk_td_change_lw_lm_per = dvr_4wk_td_change_lw_lm / dvr_4wk_td_lw_lm) %>%
mutate(
dvr_4wk_td_change_lw_lm_per_cat = if_else(
dvr_4wk_td_change_lw_lm_per <= -0.25,
"1) < (-25)%",
if_else(
dvr_4wk_td_change_lw_lm_per >= 0.25,
"4) > 25%",
if_else(
dvr_4wk_td_change_lw_lm_per <= 0,
"2) (-25)-0%",
if_else(dvr_4wk_td_change_lw_lm_per > 0, "3) 0-25%",
NA_character_)
)
)
)
)
## Select relevant columns for dvr category count change table
b_vxrate_change_lw <-
select(b_vxrate_change_lw,
"a_iso",
"dvr_4wk_td_change_lw_lm_per_cat")
## Select relevant columns for coverage category count change table
b_vxrate_cov <- select(b_vxrate_lw_sum, "a_iso", "adm_fv_lw")
c_vxrate_latest <-
left_join(c_vxrate_latest, b_vxrate_cov, by = "a_iso")
# Last month dataset
## Select relevant columns and rename
b_vxrate_lm_sum <-
select(b_vxrate_lm_sum,
c("iso_code", "total_doses", "fully_vaccinated", "at_least_one_dose","persons_booster_add_dose"))
colnames(b_vxrate_lm_sum) <- c("a_iso", "adm_td_lm", "adm_fv_lm","adm_a1d_lm","adm_booster_lm")
## Merge with current summary dataset
c_vxrate_latest <-
left_join(c_vxrate_latest, b_vxrate_lm_sum, by = "a_iso")
# Two month dataset
## Select relevant columns and rename
b_vxrate_2m_sum <-
select(b_vxrate_2m_sum,
c("iso_code", "total_doses", "fully_vaccinated", "at_least_one_dose"))
colnames(b_vxrate_2m_sum) <- c("a_iso", "adm_td_2m", "adm_fv_2m","adm_a1d_2m")
## Merge with current summary dataset
c_vxrate_latest <-
left_join(c_vxrate_latest, b_vxrate_2m_sum, by = "a_iso")
b_pop_total <-
data.frame(read_excel("data/_input/static/base_population.xlsx",
sheet = "base_population"))
b_pop_hcw <-
data.frame(read_excel("data/_input/static/base_hcw population.xlsx",
sheet = "base_hcw"))
# Reduce columns & rename
z_pop_total <- select(b_pop_total, c("COUNTRY_FK","GENDER_FK","AGEGROUP_FK",
"VALUE"))
colnames(z_pop_total) <- c("a_iso","gender","age_group","value")
z_pop_hcw <- select(b_pop_hcw, c("ISO3","Stock"))
colnames(z_pop_hcw) <- c("a_iso","a_pop_hcw")
z_pop_hcw <- z_pop_hcw %>%
mutate(a_pop_hcw = if_else(a_pop_hcw == 0, NA_real_, a_pop_hcw))
z_pop_12p <- z_pop_total %>%
filter(
gender == "BOTH" & (
age_group == "Y12" |
age_group == "Y13" |
age_group == "Y14" |
age_group == "Y15" |
age_group == "Y16" |
age_group == "Y17" |
age_group == "Y18" |
age_group == "Y19" |
age_group == "Y20" |
age_group == "Y21" |
age_group == "Y22" |
age_group == "Y23" |
age_group == "Y24" |
age_group == "Y25" |
age_group == "Y26" |
age_group == "Y27" |
age_group == "Y28" |
age_group == "Y29" |
age_group == "Y30" |
age_group == "Y31" |
age_group == "Y32" |
age_group == "Y33" |
age_group == "Y34" |
age_group == "Y35" |
age_group == "Y36" |
age_group == "Y37" |
age_group == "Y38" |
age_group == "Y39" |
age_group == "Y40" |
age_group == "Y41" |
age_group == "Y42" |
age_group == "Y43" |
age_group == "Y44" |
age_group == "Y45" |
age_group == "Y46" |
age_group == "Y47" |
age_group == "Y48" |
age_group == "Y49" |
age_group == "Y50" |
age_group == "Y51" |
age_group == "Y52" |
age_group == "Y53" |
age_group == "Y54" |
age_group == "Y55" |
age_group == "Y56" |
age_group == "Y57" |
age_group == "Y58" |
age_group == "Y59" |
age_group == "Y60" |
age_group == "Y61" |
age_group == "Y62" |
age_group == "Y63" |
age_group == "Y64" |
age_group == "Y65" |
age_group == "Y66" |
age_group == "Y67" |
age_group == "Y68" |
age_group == "Y69" |
age_group == "Y70" |
age_group == "Y71" |
age_group == "Y72" |
age_group == "Y73" |
age_group == "Y74" |
age_group == "Y75" |
age_group == "Y76" |
age_group == "Y77" |
age_group == "Y78" |
age_group == "Y79" |
age_group == "Y80" |
age_group == "Y81" |
age_group == "Y82" |
age_group == "Y83" |
age_group == "Y84" |
age_group == "Y85" |
age_group == "Y86" |
age_group == "Y87" |
age_group == "Y88" |
age_group == "Y89" |
age_group == "Y90" |
age_group == "Y91" |
age_group == "Y92" |
age_group == "Y93" |
age_group == "Y94" |
age_group == "Y95" |
age_group == "Y96" |
age_group == "Y97" |
age_group == "Y98" |
age_group == "Y99" |
age_group == "Y100"
)
) %>%
group_by(a_iso) %>%
summarize_at("value",
sum,
na.rm = TRUE
)
colnames(z_pop_12p) <- c("a_iso","a_pop_12p")
View(z_pop_12p)
View(b_vxrate)
View(b_details)
View(b_details_red)
View(b_vxrate)
z_pop_12p <- z_pop_total %>%
filter(
gender == "BOTH" & (
age_group == "Y12" |
age_group == "Y13" |
age_group == "Y14" |
age_group == "Y15" |
age_group == "Y16" |
age_group == "Y17" |
age_group == "Y18" |
age_group == "Y19" |
age_group == "Y20" |
age_group == "Y21" |
age_group == "Y22" |
age_group == "Y23" |
age_group == "Y24" |
age_group == "Y25" |
age_group == "Y26" |
age_group == "Y27" |
age_group == "Y28" |
age_group == "Y29" |
age_group == "Y30" |
age_group == "Y31" |
age_group == "Y32" |
age_group == "Y33" |
age_group == "Y34" |
age_group == "Y35" |
age_group == "Y36" |
age_group == "Y37" |
age_group == "Y38" |
age_group == "Y39" |
age_group == "Y40" |
age_group == "Y41" |
age_group == "Y42" |
age_group == "Y43" |
age_group == "Y44" |
age_group == "Y45" |
age_group == "Y46" |
age_group == "Y47" |
age_group == "Y48" |
age_group == "Y49" |
age_group == "Y50" |
age_group == "Y51" |
age_group == "Y52" |
age_group == "Y53" |
age_group == "Y54" |
age_group == "Y55" |
age_group == "Y56" |
age_group == "Y57" |
age_group == "Y58" |
age_group == "Y59" |
age_group == "Y60" |
age_group == "Y61" |
age_group == "Y62" |
age_group == "Y63" |
age_group == "Y64" |
age_group == "Y65" |
age_group == "Y66" |
age_group == "Y67" |
age_group == "Y68" |
age_group == "Y69" |
age_group == "Y70" |
age_group == "Y71" |
age_group == "Y72" |
age_group == "Y73" |
age_group == "Y74" |
age_group == "Y75" |
age_group == "Y76" |
age_group == "Y77" |
age_group == "Y78" |
age_group == "Y79" |
age_group == "Y80" |
age_group == "Y81" |
age_group == "Y82" |
age_group == "Y83" |
age_group == "Y84" |
age_group == "Y85" |
age_group == "Y86" |
age_group == "Y87" |
age_group == "Y88" |
age_group == "Y89" |
age_group == "Y90" |
age_group == "Y91" |
age_group == "Y92" |
age_group == "Y93" |
age_group == "Y94" |
age_group == "Y95" |
age_group == "Y96" |
age_group == "Y97" |
age_group == "Y98" |
age_group == "Y99" |
age_group == "Y100"
)
) %>%
group_by(a_iso) %>%
summarize_at("value",
sum,
na.rm = TRUE
)
colnames(z_pop_12p) <- c("a_iso","a_pop_12p")
# Rows 1648 - 1719
run_base <- function(env = .GlobalEnv) {
source("src/base/base_smartsheet.r")
print(" > Starting local environment for base data...")
print(" > Base smartsheet...")
b_smartsheet <- load_base_smartsheet()
b_smartsheet <- transform_base_smartsheet(
b_smartsheet
)
print(" > Done.")
print(" > WHO dashboard...")
b_who_dashboard <- load_who_dashboard()
print(" > Done.")
print(" > Concerted support list...")
b_csl <- load_conc_supp_list()
print(" > Done.")
print(" > Returning to local environment. ")
print(" > Loading data back to global environment...")
env$b_smartsheet <- b_smartsheet
env$b_who_dashboard <- b_who_dashboard
env$b_csl <- b_csl
return(environment())
}
run_base()
#export_env <- run_export()
library("readxl")
library("writexl")
library("countrycode")
library("dplyr")
library("lubridate")
library("tidyr")
library("data.table")
library("bit64")
library("openxlsx")
# HELPERS
source("helpers/joins.r")
source("helpers/transformations.r")
# ETL
source("src/base/run_base.r")
source("src/entity/run_entity.r")
source("src/population/run_population.r")
source("src/supply/run_supply.R")
source("src/vaccines/run_vaccines.r")
base_env <- run_base()
entity_env <- run_entity()
pop_env <- run_population()
supply_env <- run_supply()
vaccines_env <- run_vaccines(entity_characteristics)
# EDA
source("eda/vxrate/run_vxrate.r")
source("eda/supplies/run_supplies.r")
source("eda/coverage/run_coverage.r")
source("eda/product/run_product.r")
source("eda/rank-bin/run_rank_bin.r")
source("eda/consolidate/run_consolidate.r")
#source("eda/export/run_export.r")
vxrate_env <- run_vxrate(entity_characteristics, population_data, uptake_gender_data, c_vxrate_latest)
supplies_env <- run_eda_supplies(a_data, supply_secured, delivery_courses_doses)
coverage_env <- run_coverage(a_data)
product_env <- run_product(a_data, base_env$b_smartsheet, base_env$b_csl)
ranking_env <- run_binning(a_data)
consolidate_env <- run_consolidate(a_data)
#export_env <- run_export()
